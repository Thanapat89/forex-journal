<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <!-- PWA: Link to manifest.json (‡πÑ‡∏ü‡∏•‡πå Manifest ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Progressive Web App) -->
    <link rel="manifest" href="./manifest.json">
    <!-- PWA: Theme color for browser UI (‡∏™‡∏µ‡∏ò‡∏µ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå) -->
    <meta name="theme-color" content="#2563EB">

    <!-- Tailwind CSS CDN (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
            margin: 0;
            padding: 0;
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Container ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ */
        .container {
            max-width: 960px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô */
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        .message-box {
            position: fixed; /* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
            bottom: 1rem; /* ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á 1rem */
            left: 50%; /* ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
            transform: translateX(-50%); /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á */
            padding: 0.75rem 1.5rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô */
            border-radius: 0.5rem; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* ‡πÄ‡∏á‡∏≤ */
            z-index: 1000; /* ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à */
        .message-box.success {
            background-color: #10B981; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
            color: white;
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î */
        .message-box.error {
            background-color: #EF4444; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
            color: white;
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á */
        .tab-button {
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            border-radius: 9999px; /* rounded-full */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.3s ease-in-out; /* ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ö‡∏£‡∏∑‡πà‡∏ô */
            transform: scale(1); /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24); /* ‡πÄ‡∏á‡∏≤ */
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Active (‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà) */
        .tab-button.active {
            background-color: #2563EB; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
            color: white;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05); /* ‡πÄ‡∏á‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            transform: scale(1.05); /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Active */
        .tab-button:not(.active) {
            background-color: white;
            color: #1D4ED8; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Active ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ */
        .tab-button:not(.active):hover {
            background-color: #EFF6FF; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô */
            color: #1E40AF; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* ‡πÄ‡∏á‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ */
        }
    </style>
</head>
<body>
    <div class="container min-h-screen">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô -->
        <header class="bg-blue-700 text-white p-4 rounded-xl shadow-md mb-6">
            <h1 class="text-3xl font-bold text-center">
                <span role="img" aria-label="chart with upwards trend" class="mr-2">üìà</span>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                <span role="img" aria-label="money bag" class="ml-2">üí∞</span>
            </h1>
            <!-- ‡πÅ‡∏™‡∏î‡∏á User ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô/‡∏î‡∏µ‡∏ö‡∏±‡∏Å -->
            <p id="user-id-display" class="text-center text-sm mt-2 hidden">
                ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span class="font-mono bg-blue-800 px-2 py-1 rounded-md text-xs" id="current-user-id"></span>
            </p>
        </header>

        <!-- ‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Navigation) -->
        <nav class="flex justify-center space-x-4 mb-6 flex-wrap">
            <button id="add-trade-btn" class="tab-button active mb-2">
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏£‡∏î
            </button>
            <button id="list-trades-btn" class="tab-button mb-2">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î
            </button>
            <button id="summary-btn" class="tab-button mb-2">
                ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </button>
            <button id="export-csv-btn" class="tab-button bg-purple-600 text-white hover:bg-purple-700 mb-2">
                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CSV)
            </button>
        </nav>

        <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ -->
        <main id="app-content">
            <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JavaScript -->
        </main>

        <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î) -->
        <div id="app-message-box" class="message-box"></div>
    </div>

    <!-- Firebase SDKs (‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Firebase) -->
    <script type="module">
        // Import ‡πÇ‡∏°‡∏î‡∏π‡∏• Firebase ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firebase ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î
        let app;
        let db;
        let auth;
        let userId = null;
        let trades = []; // Array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

        // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á Element ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô HTML
        const appContent = document.getElementById('app-content');
        const addTradeBtn = document.getElementById('add-trade-btn');
        const listTradesBtn = document.getElementById('list-trades-btn');
        const summaryBtn = document.getElementById('summary-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const currentUserIdSpan = document.getElementById('current-user-id');
        const messageBox = document.getElementById('app-message-box');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
        function showMessage(message, type = 'success') {
            if (messageBox) {
                messageBox.innerText = message;
                messageBox.classList.remove('hidden', 'success', 'error'); // ‡∏•‡∏ö class ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
                messageBox.classList.add(type); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (success/error)
                setTimeout(() => {
                    messageBox.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                }, 3000);
            }
        }

        // --- ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ---
        async function initializeFirebase() {
            try {
                let firebaseConfig = {};
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse Firebase configuration ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ __firebase_config ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                try {
                    if (typeof __firebase_config === 'string' && __firebase_config) {
                        firebaseConfig = JSON.parse(__firebase_config);
                    } else {
                        throw new Error("‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Firebase configuration ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà string ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
                    }
                } catch (parseError) {
                    throw new Error(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ parse Firebase config: ${parseError.message}`);
                }

                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å parse");
                }

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app); // ‡πÑ‡∏î‡πâ Instance ‡∏Ç‡∏≠‡∏á Firestore
                auth = getAuth(app); // ‡πÑ‡∏î‡πâ Instance ‡∏Ç‡∏≠‡∏á Authentication

                let initialAuthToken = null;
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö __initial_auth_token ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                if (typeof __initial_auth_token === 'string' && __initial_auth_token) {
                    initialAuthToken = __initial_auth_token;
                }

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ user ID ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    } else {
                        // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á UUID ‡∏™‡∏∏‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ID ‡∏ó‡∏µ‡πà‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                        userId = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `anon-${Date.now()}`;
                    }
                    if (currentUserIdSpan) {
                        currentUserIdSpan.innerText = userId; // ‡πÅ‡∏™‡∏î‡∏á User ID ‡∏ö‡∏ô UI
                        userIdDisplay.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô User ID
                    }
                    fetchTrades(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    renderView('add'); // ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏£‡∏î) ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                });

                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô:", e);
                showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ: ${e.message}`, 'error');
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á
                appContent.innerHTML = `<div class="text-center text-red-700 p-4 rounded-lg bg-red-100">
                                            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ: ${e.message}<br>
                                            ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                                        </div>`;
            }
        }

        // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏à‡∏≤‡∏Å Firestore ---
        function fetchTrades() {
            if (!db || !userId) {
                console.log("Firestore DB ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Path ‡∏Ç‡∏≠‡∏á Collection ‡πÉ‡∏ô Firestore ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const tradesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/trades`);
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ï‡∏≤‡∏° timestamp ‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
            const q = query(tradesCollectionRef, orderBy('timestamp', 'desc'));

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Listener ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ onSnapshot
            onSnapshot(q, (snapshot) => {
                trades = snapshot.docs.map(doc => ({
                    id: doc.id, // ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å Firestore
                    ...doc.data(), // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                    // ‡πÅ‡∏õ‡∏•‡∏á Firestore Timestamp ‡πÄ‡∏õ‡πá‡∏ô JavaScript Date object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    timestamp: doc.data().timestamp ? doc.data().timestamp : new Date(),
                }));
                // Render ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                renderView(currentView);
            }, (error) => {
                console.error("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î:", error);
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`, 'error');
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠) ---

        function renderAddTradeForm() {
            appContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏´‡∏°‡πà</h2>
                    <form id="trade-form" class="space-y-4">
                        <div>
                            <label for="tradeDate" class="block text-sm font-medium text-gray-700 mb-1">
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡∏£‡∏î:
                            </label>
                            <input type="datetime-local" id="tradeDate"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label for="symbol" class="block text-sm font-medium text-gray-700 mb-1">
                                ‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏£‡∏î/‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:
                            </label>
                            <input type="text" id="symbol"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô BTC/USD, EUR/USD" required>
                        </div>
                        <div>
                            <label for="direction" class="block text-sm font-medium text-gray-700 mb-1">
                                ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á:
                            </label>
                            <select id="direction"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Buy">‡∏ã‡∏∑‡πâ‡∏≠ (Buy)</option>
                                <option value="Sell">‡∏Ç‡∏≤‡∏¢ (Sell)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="entryPrice" class="block text-sm font-medium text-gray-700 mb-1">
                                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (pt):
                                </label>
                                <input type="number" id="entryPrice"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    step="0.01" required>
                            </div>
                            <div>
                                <label for="stopLoss" class="block text-sm font-medium text-gray-700 mb-1">
                                    ‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (sl):
                                </label>
                                <input type="number" id="stopLoss"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    step="0.01" required>
                            </div>
                            <div>
                                <label for="takeProfit" class="block text-sm font-medium text-gray-700 mb-1">
                                    ‡∏à‡∏∏‡∏î‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£ (TP):
                                    </label>
                                <input type="number" id="takeProfit"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    step="0.01">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="result" class="block text-sm font-medium text-gray-700 mb-1">
                                    ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
                                </label>
                                <select id="result"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</option>
                                    <option value="Win">‡∏ä‡∏ô‡∏∞ (Win)</option>
                                    <option value="Loss">‡πÅ‡∏û‡πâ (Loss)</option>
                                    <option value="Break Even">‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏∏‡∏ô (Break Even)</option>
                                </select>
                            </div>
                            <div>
                                <label for="profitLoss" class="block text-sm font-medium text-gray-700 mb-1">
                                    ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô):
                                </label>
                                <input type="number" id="profitLoss"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    step="0.01" required>
                            </div>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
                            </label>
                            <textarea id="notes" rows="4"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å, ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ"></textarea>
                        </div>
                        <div>
                            <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-1">
                                URL ‡∏£‡∏π‡∏õ‡∏Å‡∏£‡∏≤‡∏ü (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):
                            </label>
                            <input type="url" id="imageUrl"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                placeholder="‡∏ß‡∏≤‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                            <div id="image-preview-container" class="mt-2 hidden">
                                <p class="text-sm text-gray-600 mb-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</p>
                                <img id="image-preview" src="" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏≤‡∏ü" class="w-full h-auto max-h-64 object-contain rounded-md border border-gray-300"
                                    onerror="this.style.display='none'; document.getElementById('image-preview-error').classList.remove('hidden');"
                                    onload="this.style.display='block'; document.getElementById('image-preview-error').classList.add('hidden');">
                                <p id="image-preview-error" class="text-red-500 text-sm mt-1 hidden">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL</p>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î
                        </button>
                    </form>
                </div>
            `;
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á input
            document.getElementById('tradeDate').value = new Date().toISOString().slice(0, 16);

            // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Image Preview
            const imageUrlInput = document.getElementById('imageUrl');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewError = document.getElementById('image-preview-error');

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            imageUrlInput.addEventListener('input', () => {
                const url = imageUrlInput.value.trim();
                if (url) {
                    imagePreviewContainer.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á container
                    imagePreview.src = url; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î src ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    imagePreview.style.display = 'block'; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
                    imagePreviewError.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                } else {
                    imagePreviewContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô container ‡∏ñ‡πâ‡∏≤ URL ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
                    imagePreview.src = ''; // ‡∏•‡πâ‡∏≤‡∏á src ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    imagePreviewError.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                }
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('trade-form').addEventListener('submit', handleAddTrade);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î
        async function handleAddTrade(e) {
            e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            if (!db || !userId) {
                console.error("Firestore DB ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î");
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const tradeDate = document.getElementById('tradeDate').value;
            const symbol = document.getElementById('symbol').value;
            const direction = document.getElementById('direction').value;
            const entryPrice = document.getElementById('entryPrice').value;
            const stopLoss = document.getElementById('stopLoss').value;
            const takeProfit = document.getElementById('takeProfit').value;
            const result = document.getElementById('result').value;
            const profitLoss = document.getElementById('profitLoss').value;
            const notes = document.getElementById('notes').value;
            const imageUrl = document.getElementById('imageUrl').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (!symbol || !entryPrice || !stopLoss || !result || !profitLoss || !tradeDate) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'error');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏´‡∏°‡πà
            const newTrade = {
                symbol,
                direction,
                entryPrice: parseFloat(entryPrice),
                stopLoss: parseFloat(stopLoss),
                takeProfit: takeProfit ? parseFloat(takeProfit) : null, // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ TP
                result,
                profitLoss: parseFloat(profitLoss),
                notes,
                imageUrl,
                timestamp: new Date(tradeDate), // ‡πÅ‡∏õ‡∏•‡∏á string ‡πÄ‡∏õ‡πá‡∏ô Date object
                createdAt: serverTimestamp(), // ‡πÉ‡∏ä‡πâ Server Timestamp ‡∏Ç‡∏≠‡∏á Firestore
            };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firestore
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/trades`), newTrade);
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('tradeDate').value = new Date().toISOString().slice(0, 16);
                document.getElementById('symbol').value = '';
                document.getElementById('direction').value = 'Buy';
                document.getElementById('entryPrice').value = '';
                document.getElementById('stopLoss').value = '';
                document.getElementById('takeProfit').value = '';
                document.getElementById('result').value = '';
                document.getElementById('profitLoss').value = '';
                document.getElementById('notes').value = '';
                document.getElementById('imageUrl').value = '';
                // ‡∏ã‡πà‡∏≠‡∏ô Image Preview ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('image-preview-container').classList.add('hidden');
                document.getElementById('image-preview').src = '';

                renderView('list'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            } catch (e) {
                console.error("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î: ", e);
                showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î: ${e.message}`, 'error');
            }
        }

        function renderTradeList() {
            if (trades.length === 0) {
                appContent.innerHTML = `
                    <div class="text-center text-gray-600 p-4">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                    </div>
                `;
                return;
            }

            let html = '<div class="space-y-4 max-w-4xl mx-auto">';
            trades.forEach(trade => {
                // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                const tradeDate = trade.timestamp && trade.timestamp.seconds ? new Date(trade.timestamp.seconds * 1000).toLocaleString('th-TH') : 'N/A';
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const resultClass = trade.result === 'Win' ? 'bg-green-100 text-green-800' :
                                    trade.result === 'Loss' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100 text-gray-800';
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô
                const profitLossClass = trade.profitLoss >= 0 ? 'text-green-700' : 'text-red-700';

                html += `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-gray-900">
                                ${trade.symbol} - ${trade.direction === 'Buy' ? '‡∏ã‡∏∑‡πâ‡∏≠' : '‡∏Ç‡∏≤‡∏¢'}
                            </h3>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${resultClass}">
                                ${trade.result === 'Win' ? '‡∏ä‡∏ô‡∏∞' : trade.result === 'Loss' ? '‡πÅ‡∏û‡πâ' : '‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏∏‡∏ô'}
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm mb-2">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${tradeDate}
                        </p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-gray-700 text-sm mb-3">
                            <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (pt):</strong> ${trade.entryPrice}</p>
                            <p><strong>SL:</strong> ${trade.stopLoss}</p>
                            ${trade.takeProfit ? `<p><strong>TP:</strong> ${trade.takeProfit}</p>` : ''}
                            <p class="font-semibold ${profitLossClass}">
                                <strong>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô:</strong> ${trade.profitLoss.toFixed(2)}
                            </p>
                        </div>
                        ${trade.notes ? `
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3">
                                <p class="text-sm font-medium text-gray-800 mb-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</p>
                                <p class="text-gray-700 text-sm whitespace-pre-wrap">${trade.notes}</p>
                            </div>
                        ` : ''}
                        ${trade.imageUrl ? `
                            <div class="mt-4">
                                <img src="${trade.imageUrl}" alt="‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î"
                                    class="w-full h-auto rounded-lg shadow-md object-cover"
                                    onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/333333?text=‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';">
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            appContent.innerHTML = html;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        function renderMonthlySummary() {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î
            const summarizeTrades = (tradesToSummarize) => {
                const summary = {};
                tradesToSummarize.forEach(trade => {
                    if (!trade.timestamp || !trade.timestamp.seconds) {
                        return;
                    }
                    const date = new Date(trade.timestamp.seconds * 1000);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                    if (!summary[monthYear]) {
                        summary[monthYear] = {
                            totalPL: 0,
                            totalWin: 0,
                            totalLoss: 0,
                            totalBreakEven: 0,
                            tradeCount: 0,
                        };
                    }
                    summary[monthYear].totalPL += trade.profitLoss;
                    summary[monthYear].tradeCount++;
                    if (trade.result === 'Win') {
                        summary[monthYear].totalWin++;
                    } else if (trade.result === 'Loss') {
                        summary[monthYear].totalLoss++;
                    } else {
                        summary[monthYear].totalBreakEven++;
                    }
                });
                for (const month in summary) {
                    const { totalWin, tradeCount } = summary[month];
                    summary[month].winRate = tradeCount > 0 ? ((totalWin / tradeCount) * 100).toFixed(2) : 0;
                }
                return summary;
            };

            const tradeSummary = summarizeTrades(trades);
            const availableMonths = Object.keys(tradeSummary).sort().reverse(); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
            let selectedMonth = availableMonths.length > 0 ? availableMonths[0] : ''; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

            let html = `
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                    <div class="mb-6">
                        <label for="monthSelect" class="block text-sm font-medium text-gray-700 mb-1">
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:
                        </label>
                        <select id="monthSelect"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            ${availableMonths.length > 0 ?
                                availableMonths.map(month => `<option value="${month}">${new Date(month).toLocaleString('th-TH', { month: 'long', year: 'numeric' })}</option>`).join('')
                                : '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>'
                            }
                        </select>
                    </div>
                    <div id="monthly-summary-details"></div>
                </div>
            `;
            appContent.innerHTML = html;

            const monthSelect = document.getElementById('monthSelect');
            const monthlySummaryDetails = document.getElementById('monthly-summary-details');

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ
            const updateSummaryDisplay = () => {
                const currentMonth = monthSelect.value;
                const currentSummary = tradeSummary[currentMonth] || {
                    totalPL: 0, totalWin: 0, totalLoss: 0, totalBreakEven: 0, tradeCount: 0, winRate: 0,
                };

                if (currentMonth && availableMonths.includes(currentMonth)) {
                    monthlySummaryDetails.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <p class="text-lg font-semibold text-blue-800 mb-2">
                                    ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${new Date(currentMonth).toLocaleString('th-TH', { month: 'long', year: 'numeric' })}:
                                </p>
                                <p class="text-xl font-bold ${currentSummary.totalPL >= 0 ? 'text-green-700' : 'text-red-700'}">
                                    ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: ${currentSummary.totalPL.toFixed(2)}
                                </p>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center">
                                    <p class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                    <p class="text-2xl font-bold text-gray-800">${currentSummary.tradeCount}</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200 text-center">
                                    <p class="text-sm text-green-600">‡∏ä‡∏ô‡∏∞</p>
                                    <p class="text-2xl font-bold text-green-800">${currentSummary.totalWin}</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg border border-red-200 text-center">
                                    <p class="text-sm text-red-600">‡πÅ‡∏û‡πâ</p>
                                    <p class="text-2xl font-bold text-red-800">${currentSummary.totalLoss}</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-center">
                                    <p class="text-sm text-yellow-600">‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏∏‡∏ô</p>
                                    <p class="text-2xl font-bold text-yellow-800">${currentSummary.totalBreakEven}</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 text-center col-span-full sm:col-span-1">
                                    <p class="text-sm text-purple-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞</p>
                                    <p class="text-2xl font-bold text-purple-800">${currentSummary.winRate}%</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    monthlySummaryDetails.innerHTML = `
                        <div class="text-center text-gray-600 p-4">
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        </div>
                    `;
                }
            };
            
            monthSelect.value = selectedMonth; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö dropdown
            updateSummaryDisplay(); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

            monthSelect.addEventListener('change', updateSummaryDisplay); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        }

        // --- ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô CSV ---
        function exportTradesToCsv() {
            if (trades.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å', 'error');
                return;
            }

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Header ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå CSV
            const headers = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡∏£‡∏î", "‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏£‡∏î/‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á", "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (pt)", "‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (sl)", "‡∏à‡∏∏‡∏î‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£ (TP)", "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå", "‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "URL ‡∏£‡∏π‡∏õ‡∏Å‡∏£‡∏≤‡∏ü"];
            const csvRows = [];
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Header ‡∏•‡∏á‡πÉ‡∏ô CSV
            csvRows.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',')); // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÉ‡∏ô Header

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß CSV
            trades.forEach(trade => {
                const row = [
                    trade.timestamp && trade.timestamp.seconds ? new Date(trade.timestamp.seconds * 1000).toLocaleString('th-TH') : '',
                    `"${String(trade.symbol || '').replace(/"/g, '""')}"`, // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String
                    `"${String(trade.direction || '').replace(/"/g, '""')}"`,
                    trade.entryPrice || '',
                    trade.stopLoss || '',
                    trade.takeProfit || '',
                    `"${String(trade.result || '').replace(/"/g, '""')}"`,
                    trade.profitLoss || '',
                    `"${String(trade.notes || '').replace(/"/g, '""').replace(/\n/g, '\\n')}"`, // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÅ‡∏•‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
                    `"${String(trade.imageUrl || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(',')); // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤
            });

            const csvString = csvRows.join('\n'); // ‡∏£‡∏ß‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob ‡∏à‡∏≤‡∏Å String CSV
            const link = document.createElement('a'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Element <a> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            link.href = URL.createObjectURL(blob); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Blob
            link.download = `trading_journal_${new Date().toISOString().slice(0, 10)}.csv`; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
            document.body.appendChild(link); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Link ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Body
            link.click(); // ‡∏Ñ‡∏•‡∏¥‡∏Å Link ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            document.body.removeChild(link); // ‡∏•‡∏ö Link ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Body
            showMessage('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let currentView = 'add'; // ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏£‡∏î'

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
        function renderView(viewName) {
            currentView = viewName; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            // ‡∏•‡∏ö Class 'active' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            addTradeBtn.classList.remove('active');
            listTradesBtn.classList.remove('active');
            summaryBtn.classList.remove('active');
            exportCsvBtn.classList.remove('active');

            // Render ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Class 'active' ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            if (viewName === 'add') {
                renderAddTradeForm();
                addTradeBtn.classList.add('active');
            } else if (viewName === 'list') {
                renderTradeList();
                listTradesBtn.classList.add('active');
            } else if (viewName === 'summary') {
                renderMonthlySummary();
                summaryBtn.classList.add('active');
            } else if (viewName === 'export') {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏Ñ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏á‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ
                exportTradesToCsv();
                // ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ active ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° export ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Action
            }
        }

        // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
        addTradeBtn.addEventListener('click', () => renderView('add'));
        listTradesBtn.addEventListener('click', () => renderView('list'));
        summaryBtn.addEventListener('click', () => renderView('summary'));
        exportCsvBtn.addEventListener('click', () => renderView('export'));

        // PWA: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered! Scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('Service Worker registration failed:', err);
                    });
            });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        window.onload = initializeFirebase;
    </script>
</body>
</html>
